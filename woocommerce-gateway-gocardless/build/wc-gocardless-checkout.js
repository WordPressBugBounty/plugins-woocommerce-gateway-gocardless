jQuery((function(e){window.wc_gocardless_checkout_handler=new class{constructor(r){this.id="gocardless",this.order_id=r.order_id,this.is_test=r.is_test,this.ajax_url=r.ajax_url,this.generic_error=r.generic_error,this.is_order_pay_page=r.is_order_pay_page,this.create_billing_request_nonce=r.create_billing_request_nonce,this.complete_billing_request_nonce=r.complete_billing_request_nonce,window.GoCardlessDropin?e("form.checkout").length?(this.form=e("form.checkout"),this.handleCheckoutPage()):e("form#order_review").length&&(this.form=e("form#order_review"),this.handlePayPage()):console.error("GoCardless Dropin is not loaded.")}handleCheckoutPage(){this.form.on("checkout_place_order_success",((e,r)=>this.handleOrderSuccess(r)))}handlePayPage(){this.form.on("submit",(()=>{if(e("#order_review input[name=payment_method]:checked").val()===this.id&&(0===e("#order_review input[name=wc-gocardless-payment-token]").length||"new"===e("#order_review input[name=wc-gocardless-payment-token]:checked").val()))return this.validatePayment()})),e(document).ready((function(){e(document.body).trigger("wc-credit-card-form-init")}))}validatePayment(){return!(this.form.is(".processing")||!this.hasBillingRequestId()&&(this.blockUI(),this.handleSubmission(),1))}handleSubmission(){this.createBillingRequestFlow().then((r=>{const{billing_request_flow_id:o}=r;this.initDropIn({billingRequestFlowID:o,environment:this.is_test?"sandbox":"live",onSuccess:(r,o)=>{r&&["fulfilling","fulfilled"].includes(r.status)&&r.id?(this.closeDropIn(),e('input[name="wc-gocardless-billing-request-id"]').val(r.id),this.form.trigger("submit")):(this.renderError(this.generic_error),this.unblockUI())},onExit:(e,r)=>{e&&console.error(e)}}).open(),this.unblockUI()})).catch((e=>{console.error(e),this.renderError(this.generic_error),this.unblockUI()}))}createBillingRequestFlow(){return new Promise(((r,o)=>{const i={security:this.create_billing_request_nonce,order_id:this.order_id};e("#wc-gocardless-new-payment-method").is(":checked")&&(i["wc-gocardless-new-payment-method"]=!0);let t=this.ajax_url.replace("%%endpoint%%","gocardless_create_billing_request_flow");const s=new URLSearchParams(window.location.search);this.is_order_pay_page&&s.has("change_payment_method")&&(t+=`&change_payment_method=${s.get("change_payment_method")}`),e.ajax({url:t,type:"POST",cache:!1,data:i,complete:e=>{const i=e.responseJSON;return i&&i.success?r(i.data):o(i)}})}))}hasBillingRequestId(){return e('input[name="wc-gocardless-billing-request-id"]').val()}handleOrderSuccess(r){const{billing_request_flow_id:o,result:i,order_id:t,redirect:s,billing_request_nonce:n}=r;if("success"!==i||e('#payment input[name="payment_method"]:checked').val()!==this.id||!o)return!0;this.initDropIn({billingRequestFlowID:o,environment:this.is_test?"sandbox":"live",onSuccess:(e,r)=>{this.handleDropInSuccess(t,e,r,n)},onExit:(e,r)=>{e&&console.error(e),window.location.href=s}}).open(),r.redirect="#"}handleDropInSuccess(r,o,i,t=null){this.blockUI(),o&&["fulfilling","fulfilled"].includes(o.status)?(this.closeDropIn(),e.ajax({type:"POST",url:this.ajax_url.replace("%%endpoint%%","gocardless_complete_billing_request_flow"),data:{security:t||this.complete_billing_request_nonce,order_id:r,billing_request_id:o.id,billing_request_flow_id:i.id,save_customer_token:e("#wc-gocardless-new-payment-method").is(":checked")?"yes":"no"},success:e=>{e.success?window.location.href=e.data.redirect_url:(this.unblockUI(),e.data?.message?this.renderError(e.data.message):this.renderError(this.generic_error))},error:e=>{this.unblockUI(),console.error(e),this.renderError(this.generic_error)}})):this.renderError(this.generic_error)}renderError(r){e(".woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message, .is-error, .is-success").remove(),this.form.prepend('<div class="woocommerce-NoticeGroup woocommerce-NoticeGroup-checkout"><div class="woocommerce-error">'+r+"</div></div>"),this.form.removeClass("processing").unblock(),this.form.find(".input-text, select, input:checkbox").trigger("validate").trigger("blur");let o=e(".woocommerce-NoticeGroup-updateOrderReview, .woocommerce-NoticeGroup-checkout");o.length||(o=this.form),e("html, body").animate({scrollTop:o.offset().top-100},1e3),e(document.body).trigger("checkout_error",[r])}blockUI(e=null){this.form.block({message:e,overlayCSS:{background:"#fff",opacity:.6}})}unblockUI(){this.form.unblock()}closeDropIn(){this.handler&&this.handler.exit()}initDropIn(e){const{GoCardlessDropin:r}=window;return this.handler=r.create(e),this.handler}}(window.wc_gocardless_checkout_params)}));